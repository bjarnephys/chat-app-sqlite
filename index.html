<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Min SQLite ChatApp</title>
	
    <style>
	
   :root {
    --primary-color: #0084ff; /* Messenger bl√• */
    --bg-color: #f0f2f5;
    --msg-mine: #0084ff;
    --msg-theirs: #e4e6eb;
}

body { 
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
    background-color: var(--bg-color);
    margin: 0; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    height: 100vh; 
}

#chat-container { 
    width: 100%; 
    max-width: 500px; 
    height: 90vh; 
    background: white; 
    display: flex; 
    flex-direction: column; 
    box-shadow: 0 12px 28px rgba(0,0,0,0.1);
    border-radius: 10px;
    overflow: hidden;
}

#messages { 
    flex: 1; 
    overflow-y: auto; 
    padding: 20px; 
    display: flex; 
    flex-direction: column; 
    gap: 8px; /* Luft mellem beskeder */
}

/* Chat-bobler */
#messages li { 
    list-style: none;
    padding: 10px 16px; 
    border-radius: 18px; 
    max-width: 75%; 
    font-size: 15px;
    line-height: 1.4;
    position: relative;
}

/* Beskeder fra andre */
#messages li:not(.my-msg) { 
    background-color: var(--msg-theirs); 
    align-self: flex-start; 
    color: black;
}

/* Dine egne beskeder */
#messages .my-msg { 
    background-color: var(--msg-mine); 
    color: white; 
    align-self: flex-end; 
}
		
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>Velkommen</h2>
        <input type="email" id="email-input" placeholder="E-mail" required>
        <input type="password" id="password-input" placeholder="Adgangskode" required>
        
        <div style="text-align: left; font-size: 14px; margin: 10px 0;">
            <input type="checkbox" id="new-user-check"> Jeg er ny bruger
        </div>
        
        <button id="login-btn">Log ind / Opret</button>
        <p id="error-msg"></p>
    </div>

    <div id="chat-container">
        <div id="chat-header">
            <span id="display-user">Chat</span>
            <select id="room-select" style="width: auto; margin: 0;">
                <option value="Generelt">üè† Generelt</option>
                <option value="Sport">‚öΩ Sport</option>
                <option value="Kodning">üíª Kodning</option>
            </select>
        </div>

        <ul id="messages"></ul>

        <form id="form">
            <input id="input" autocomplete="off" placeholder="Skriv en besked..." />
            <button id="send-btn" type="submit">Send</button>
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // DOM Elementer
        const loginScreen = document.getElementById('login-screen');
        const chatContainer = document.getElementById('chat-container');
        const loginBtn = document.getElementById('login-btn');
        const emailInput = document.getElementById('email-input');
        const passInput = document.getElementById('password-input');
        const newUserCheck = document.getElementById('new-user-check');
        const errorMsg = document.getElementById('error-msg');
        
        const roomSelect = document.getElementById('room-select');
        const messages = document.getElementById('messages');
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const displayUser = document.getElementById('display-user');

        let currentUserEmail = "";

        // --- AUTHENTICATION ---
        loginBtn.addEventListener('click', () => {
            const data = {
                email: emailInput.value,
                password: passInput.value,
                isNewUser: newUserCheck.checked
            };
			//alert(data);
            socket.emit('authenticate', data);
        });

        socket.on('auth response', (res) => {
            if (res.success) {
                currentUserEmail = res.email;
                displayUser.textContent = `Logget ind som: ${res.email}`;
                loginScreen.style.display = 'none';
                chatContainer.style.display = 'flex'; //optager hele plads, dog med max-width=500
                // Join standard rum efter login
                socket.emit('join room', roomSelect.value);
            } else {
                errorMsg.textContent = res.message;
            }
        });

        // --- RUM LOGIK ---
        roomSelect.addEventListener('change', () => {
			
            socket.emit('join room', roomSelect.value);
        });

        // --- MODTAG DATA ---
        socket.on('chat history', (rows) => {
            messages.innerHTML = ''; // Rens sk√¶rmen f√∏r historikken tegnes
			addMessageToUI(`--- Velkommen til ${roomSelect.value} ---`, 'system-msg');
     
            rows.forEach(row => {
                addMessageToUI(`[${row.timestamp}] ${row.message}`);
            });
        });

        socket.on('chat message', (msg) => {
            addMessageToUI(msg,'my-msg');
			//addMessageToUI(msg);
        });

        // --- SEND BESKED ---
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (input.value) {
                // Vi sender rum, besked og brugerens email til serveren
                socket.emit('chat message', {
					user: currentUserEmail,
                    room: roomSelect.value,
                    //msg: `${currentUserEmail}: ${input.value}`
					msg: `${input.value}`
                });
                input.value = '';
            }
        });

        // Hj√¶lpefunktion til UI
		/*
        function addMessageToUI(text, className = '') {
            const item = document.createElement('li');
            item.textContent = text;
            if (className) item.classList.add(className);
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        }
		*/
		function addMessageToUI(text, className = '') {
			const item = document.createElement('li');
			item.textContent = text;
			
			// Hvis beskeden starter med din egen email, giv den klassen 'my-msg'
			if (text.startsWith(currentUserEmail)) {
				item.classList.add('my-msg');
			}
			
			if (className) item.classList.add(className);
			messages.appendChild(item);
			messages.scrollTop = messages.scrollHeight;
		}

    </script>
</body>
</html>